if(!window.requestAnimationFrame)window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c){window.setTimeout(c,1E3/60)}}();if(!Game)var Game={};
Game.GameTime=function(){var c=jQuery(this),e=0,a=false,b,g=Date.now||function(){return(new Date).getTime()};this.getElapsed=function(){return 0};this.getFPS=function(){return e};this.start=function(){if(!a){a=true;var f=g(),d=1/60;if(b){d=f-b;e=1E3/d}b=f;c.trigger("tick",d);window.requestAnimationFrame(start)}};this.stop=function(){if(a){a=false;b=null}};return this};Math.clamp=function(a,b,c){return a<b?b:a>c?c:a};Math.toRadians=function(a){return a*Math.PI/180};Math.toDegrees=function(a){return a*180/Math.PI};TerrainGenerator=function(){this.generateTerrain=function(a){switch(a){case TerrainGenerator.TYPE_CIRCLEHILL:a=new Array2(201,40);a.fill(50);for(var b=1;b<25;b++)for(var c=~~(Math.random()*201),f=~~(Math.random()*40),d=0;d<200;d++)for(var e=0;e<39;e++){var g=(c-d)*(c-d)+(f-e)*(f-e);if(g<100){g=100*(1+Math.cos(Math.PI*g/100));a.set(d,e,Math.min(a.get(d,e)+g,400))}}return a;case TerrainGenerator.TYPE_LIMITEDRANDOM:a=new Array2(201,40);for(b=0;b<a.getWidth()-1;b++)for(c=0;c<a.getHeight()-1;c++){f=0;
f=b!=0&&c!=0?(a.get(b-1,c)+a.get(b,c-1))/2:b!=0&&c==0?a.get(b-1,c):Math.random()*40;a.set(b,c,Math.max(50,Math.min(f+100*(Math.random()-0.5),500)))}return a}}};TerrainGenerator.TYPE_CIRCLEHILL="circleHill";TerrainGenerator.TYPE_LIMITEDRANDOM="limitedRandom";function Array2(c,f){this.getWidth=function(){return c};this.getHeight=function(){return f};this.get=function(d,b){var a=d+b*c;if(a>=0&&a<e.length)return e[a]};this.set=function(d,b,a){e[d+b*c]=a};this.fill=function(d){for(var b=0;b<c;b++)for(var a=0;a<f;a++)e[b+a*c]=d};var e=[]};if(!Game)var Game={};Game.createNamespace=function(a){a=a.split(".");for(var b=Game,c=0;c<a.length;c++){if(typeof b[a[c]]==="undefined")b[a[c]]={};b=b[a[c]]}return b};Game.createNamespace("engine.config");Game.engine.config.scale=5;
Game.init=function(){if(Modernizr.canvas){var a=Game.engine.config;a.getStageWidth=function(){return b.offsetWidth};a.getStageHeight=function(){return b.offsetHeight};a.numberOfPlayers=2;var b=Game.stage=document.getElementById("stage"),c=Game.root=document.createElement("canvas");c.width=b.offsetWidth;c.height=b.offsetHeight;c.id="root";b.appendChild(c);var e=Game.gameTime=new Game.GameTime,d=new WorldListener,g=Game.engine.physics.createWorld().withWorldListener(d).createEarth(),h=Game.engine.canvasController=
new CanvasController,i=Game.engine.renderer;i.renderEarth(h.background);Game.createNamespace("input");Game.input=new InputController(c,a,g);var j=Game.engine.effects=new EffectsController(h.dynamics);$(e).bind(function(k,f){d.tick(f);g.step(f);i.render();j.updateAndRender(f)});Game.connectAndLogin()}else document.write("This browser does not support the canvas element.")};
Game.connectAndLogin=function(){var a=new LoginWindowController,b=Game.engine.es=new ElectroServer;b.initialize();var c=new ElectroServer.Server("server1");c.addAvailableConnection(new ElectroServer.AvailableConnection("127.0.0.1",8989,ElectroServer.TransportType.BinaryHTTP));b.engine.addServer(c);b.engine.addEventListener(MessageType.ConnectionResponse,function(e){b.engine.removeEventListener(MessageType.ConnectionResponse,arguments.callee);if(e.successful){console.log("Connected successfully.");
a.createLoginWindow(function(d){console.log("Login as "+d)})}else{console.log("Could not connect.");a.createConnectionFailureWindow()}});b.engine.connect()};
Game.findMatch=function(){var a=new QuickJoinGameRequest;a.gameType="match";a.zoneName="match";var b=new SearchCriteria;b.gameType="match";a.critera=b;Game.engine.es.engine.addEventListener(MessageType.CreateOrJoinGameResponse,function(c){Game.engine.es.engine.removeEventListener(MessageType.CreateOrJoinGameResponse,arguments.callee);c.error?console.log("Could not join a game : "+c.error):console.log("Joined successfully.")});Game.engine.es.engine.send(a)};
Game.startGame=function(){console.log("Starting game.");var a=Game.input.makePlayers();Game.engine.physics.createPlayers(a);Game.engine.canvasController.updateWind(Game.engine.physics.getWind());setInterval(function(){Game.engine.canvasController.updateFps(Game.gameTime.getFPS())},1E3);Game.engine.canvasController.showHUD();Game.gameTime.start();Game.input.startRound()};Game.errorTitles=["Our gigabytes aren't working right now...","Check your RAM fluid!","Unexpected tachyon surge!"];
Game.getRandomErrorTitle=function(){return Game.errorTitles[~~(Game.errorTitles.length*Math.random())]};Game.createNamespace("engine.renderer");
Game.engine.renderer=function(){function l(e,b,a){var f=Game.engine.config.scale;a.strokeStyle=e.isEarth==true?"#AC7F24":"#FF0000";a.fillStyle=a.strokeStyle;a.beginPath();switch(b.m_type){case b2Shape.e_polyShape:e=b2Math.AddVV(b.m_position,b2Math.b2MulMV(b.m_R,b.m_vertices[0]));e.Multiply(f);a.moveTo(e.x,e.y);for(var d=0;d<b.m_vertexCount;d++){var c=b2Math.AddVV(b.m_position,b2Math.b2MulMV(b.m_R,b.m_vertices[d]));c.Multiply(f);a.lineTo(c.x,c.y)}a.lineTo(e.x,e.y);a.fill();break;case b2Shape.e_circleShape:a.fillStyle=
a.strokeStyle;a.arc(b.m_position.x*f,b.m_position.y*f,b.m_maxRadius*f,0,2*Math.PI,false);a.fill()}a.stroke()}var k=Game.engine.renderer,i=new Image;i.onload=function(){i.isloaded=true};i.src="resources/tank1.png";k.renderEarth=function(e){e=e.getContext("2d");for(var b=Game.engine.physics.getWorldBodies();b;b=b.m_next)for(var a=b.GetShapeList();null!=a;a=a.GetNext())b.isEarth&&l(b,a,e)};k.render=function(){var e=Game.engine.canvasController.dynamics.getContext("2d"),b=Game.engine.canvasController.players.getContext("2d");
e.canvas.width=e.canvas.width;b.canvas.width=b.canvas.width;for(var a=Game.engine.physics.getWorldBodies();a;a=a.m_next)for(var f=a.GetShapeList();null!=f;f=f.GetNext())if(a.isPlayer){var d=a,c=b,h=Game.engine.config.scale;if(i.isloaded==true){var g=d.topLeft;if(!g){g=b2Math.AddVV(f.m_position,b2Math.b2MulMV(f.m_R,f.m_vertices[0]));g.Multiply(h);d.topLeft=g}c.rotate(d.GetRotation());h=b2Math.b2MulMV(new b2Mat22(-d.GetRotation()),g);c.drawImage(i,0,0,12,12,h.x,h.y,12,12);c.rotate(-d.GetRotation());
h=new b2Vec2(0,-10);h=b2Math.b2MulMV(new b2Mat22(Math.toRadians(d.player.angle)),h);var j=g.Copy();j.x+=6;h=b2Math.AddVV(j,h);c.beginPath();c.strokeStyle="#000000";c.moveTo(j.x,j.y);c.lineTo(h.x,h.y);c.stroke();if(d.player.isActive){c.beginPath();c.strokeStyle="#FFFFFF";c.arc(g.x+6,g.y+6,20,0,2*Math.PI,false);c.stroke();d=d.player.health;c.beginPath();c.fillStyle=d>80?"#008B00":d>50?"#FFD700":d>20?"#FF4500":"#FF0000";c.fillRect(g.x+22,g.y+22,12*(d/100),4);c.strokeStyle="#FFFFFF";c.strokeRect(g.x+
22,g.y+22,12,4);c.stroke()}}}else a.isEarth||l(a,f,e)};return k}();Game.createNamespace("engine.physics");
Game.engine.physics=function(){var d=Game.engine.physics,r=new TerrainGenerator,l=Game.engine.config,f;d.createWorld=function(){var c=new b2AABB;c.minVertex.Set(-10,-1E3);c.maxVertex.Set(l.getStageWidth()+10,l.getStageHeight()+10);f=new b2World(c,new b2Vec2(0,10),true);return d};d.getWorldBodies=function(){return f?f.m_bodyList:[]};d.getBodyCount=function(){return f?f.m_bodyCount:0};d.destroyBody=function(c){f.DestroyBody(c);return d};d.createBody=function(c){f.CreateBody(c);return d};d.getGravity=
function(){return f.m_gravity.Copy()};var n;d.withWorldListener=function(c){n=c;d.worldListener=n;f.SetListener(n);return d};var m,o=[];d.createEarth=function(){f.m_gravity=new b2Vec2((Math.random()+-0.5)*(Math.random()*10+3),10);m=r.generateTerrain(TerrainGenerator.TYPE_CIRCLEHILL);for(var c=m.getWidth(),g=m.getHeight(),a=l.scale,e=2*l.getStageWidth()/c,i=l.getStageHeight(),b;!b;)b=~~(Math.random()*g);var h,j;o=[];for(var k=0;k<c-2;k++){h=m.get(k,b);j=m.get(k+1,b);o.push(h+100);o.push(j+100);g=new b2PolyDef;
g.vertexCount=4;g.vertices[0].Set(0,0);g.vertices[1].Set(0,-h/a);g.vertices[2].Set(e/a,-j/a);g.vertices[3].Set(e/a,0);h=new b2BodyDef;h.position.Set(k*e/a,(i-100)/a);h.AddShape(g);f.CreateBody(h).isEarth=true}return d};d.getWind=function(){return f.m_gravity.x};d.createPlayers=function(c){function g(s){for(var q=0;q<e.length;q++)if(Math.abs(e[q]-s)<100)return true;return false}for(var a=Game.engine.config.scale,e=[],i=l.getStageWidth()/m.getWidth(),b,h=0;h<c.length;h++){var j=new b2PolyDef;j.vertexCount=
4;j.vertices[0].Set(0,0);j.vertices[1].Set(12/a,0);j.vertices[2].Set(12/a,12/a);j.vertices[3].Set(0,12/a);var k=new b2BodyDef;for(b=null;!b;){var p=~~(Math.random()*(l.getStageWidth()-100))+100;if(!g(p)){b=p;e.push(b)}}p=~~(b/i);k.position.Set(b/a,(l.getStageHeight()-(o[p]+o[p+1])/2-12)/a);k.AddShape(j);b=f.CreateBody(k);b.isPlayer=true;b.player=c[h];b.onContact=n.onPlayerContact;c[h].body=b}};d.fire=function(c,g){var a=Game.engine.config.scale,e=c.body,i=b2Math.b2MulMV(new b2Mat22(Math.toRadians(c.angle)),
new b2Vec2(0,-3));e=e.topLeft.Copy();e.Multiply(1/a);e.x+=6/a;e=b2Math.AddVV(e,i);var b=new b2CircleDef;b.radius=2/a;b.density=1;b.friction=0;b.restitution=0.3;i.Multiply(c.power/100);a=new b2BodyDef;a.position.Set(e.x,e.y);a.linearVelocity=i;a.AddShape(b);i=f.CreateBody(a);i.projectileType=g;n.trackProjectile(i)};d.step=function(){f.Step(step,1)};return d}();function WorldListener(){var f=this,g=Game.engine.physics,i=Game.engine.config.scale,h=Game.engine.config.getStageWidth(),j=Game.engine.config.getStageHeight();this.tickHandler=function(){};this.onPlayerContact=function(a,e){if(typeof e.projectileType!="undefined"){var c=a.player;switch(e.projectileType){case "bullet":c.health-=30;case "mortar":c.health-=40}}};this.onProjectileContact=function(a,e){if(e.IsStatic()&&typeof a.projectileType!="undefined")switch(a.projectileType){case "bullet":clearInterval(a.trackingInterval);
g.destroyBody(a);$(f).trigger("worldSleeping");break;case "mortar":clearInterval(a.trackingInterval);var c=a.GetOriginPosition();c.Multiply(i);var d=g.getGravity();d.Multiply(0.01);var b=new cParticleSystem;b.position=Vector.create(c.x,c.y);b.startColour=[255,69,0,1];b.endColour=[255,0,0,1];b.size=20;b.maxParticles=2E4;b.duration=0.0010;b.gravity=Vector.create(d.x,d.y);b.init();Game.engine.effects.registerParticleSystem(b);g.destroyBody(a);$(f).trigger("worldSleeping")}};this.trackProjectile=function(a){a.onContact=
f.onProjectileContact;var e=0;a.trackingInterval=setInterval(function(){var c=a.GetLinearVelocity(),d=a.GetOriginPosition(),b;if(!(b=a.IsSleeping())){if(!(b=e>10&&c.x<0.1&&c.y<0.1))b=e<=10?d.x<0&&c.x<0||d.x>h&&c.x>0:e>10&&(d.x<0||d.x>h||d.y<0||d.y>j);b=b}if(b){clearInterval(a.trackingInterval);g.destroyBody(a);$(f).trigger("worldSleeping")}e+=1},1E3)};this.NotifyBoundaryViolated=function(){};this.NotifyJointDestroyed=function(){}};function Player(a){for(var b in a)this[b]=a[b]};function InputController(k,h,i){function f(b){d=b;for(b=0;b<c.length;b++)c[b].isActive=b==d;Game.engine.canvasController.updatePlayerInformation(c[d]);$(document).bind("keydown",g)}function g(b){if(!j){var a=c[d];switch(b.which){case 32:$(document).unbind("keydown",g);$(e.worldListener).bind("worldSleeping",function(){$(e.worldListener).unbind("worldSleeping",arguments.callee);f((d+1)%c.length)});c[d].isActive=false;e.fire(a,"bullet");break;case 38:a.power=Math.clamp(a.power+4,100,2E3);break;case 40:a.power=
Math.clamp(a.power-4,100,2E3);break;case 39:a.angle=Math.clamp(a.angle+1,-90,90);break;case 37:a.angle=Math.clamp(a.angle-1,-90,90);break;default:return}Game.engine.canvasController.updatePlayerInformation(a)}}var e=i,c=[],d=0;this.getPlayers=function(){return c};this.makePlayers=function(){c=[];for(var b,a=0;a<h.numberOfPlayers;a++){b=new Player({color:"#FFFFFF",playerName:"Ben"+a,angle:0,power:750,health:100,weapons:[new Missile(999),new Mortar(10)]});c.push(b)}return c};this.startRound=function(){f(0)};
var j};function CanvasController(){function h(c){var b=document.createElement("canvas");b.id=c;b.style.position="absolute";b.style.right="0px";b.style.top="0px";b.width=g.width;b.height=g.height;return b}var g=Game.root,f=Game.stage,q=Game.gameTime;this.background=h("background");f.appendChild(this.background);this.dynamics=h("dynamics");f.appendChild(this.dynamics);this.players=h("players");f.appendChild(this.players);var k=h("wind");f.appendChild(k);var d=document.createElement("div");d=document.createElement("div");
d.style.position="absolute";d.style.right="0px";d.style.top="0px";d.width=g.width;d.height=g.height;var a=document.createElement("div");a.id="panel";var i=document.createElement("div");i.id="contentTab";a.appendChild(i);var j=document.createElement("div");j.id="popoutTab";a.appendChild(j);var l=new PanelController(a,i,j);this.uiController=l;a=document.createElement("p");var m=document.createTextNode("FPS : 0");a.appendChild(m);d.appendChild(a);a=document.createElement("p");var n=document.createTextNode("Player : ");
a.appendChild(n);d.appendChild(a);a=document.createElement("p");var o=document.createTextNode("Angle : ");a.appendChild(o);d.appendChild(a);a=document.createElement("p");var p=document.createTextNode("Power : ");a.appendChild(p);d.appendChild(a);this.showHUD=function(){f.appendChild(d)};this.hideHUD=function(){f.removeChild(d)};this.updateFps=function(){m.nodeValue="FPS : "+~~q.getFPS()};this.updatePlayerInformation=function(c){n.nodeValue="Player : "+c.playerName;o.nodeValue="Angle : "+c.angle;p.nodeValue=
"Power : "+c.power;l.populate(c)};this.updateWind=function(c){var b=k.getContext("2d");b.strokeStyle="#00FF00";var e=g.width-50;c=e+Math.min(c*10,e);b.moveTo(e,120);b.lineTo(c,120);e=c<e?5:-5;b.lineTo(c+e,115);b.moveTo(c,120);b.lineTo(c+e,125);b.stroke()}};function PanelController(d,g,h){d.style.left="-570px";this.toggle=function(){var a;if(d.style.left=="-570px")a=0;else if(d.style.left=="0px")a=-570;else return;$(d).animate({left:a+"px"},200)};$(h).click(this.toggle);var c;this.populate=function(a){c&&g.removeChild(c);c=document.createElement("div");for(var e,b,f=0;f<a.weapons.length;f++){b=a.weapons[f];e=document.createElement("p");e.id=a.name+"_"+b.name;e.appendChild(document.createTextNode(b.name+" : "+b.damage+" : "+b.splash+" : "+b.quantity));
c.appendChild(e)}g.appendChild(c)}};function LoginWindowController(){var b,c;$(document).ready(function(){c=$("#loginView");$(c).dialog({autoOpen:false,modal:true,draggable:false,resizable:false,buttons:{Login:function(){$(this).dialog("close")}}});b=$("#loginFailureView");$(b).dialog({autoOpen:false,modal:true,draggable:false,resizable:false,title:Game.getRandomErrorTitle()})});this.createConnectionFailureWindow=function(a){$(b).bind("dialogclose",function(){null!=a&&a()}).dialog("open")};this.createLoginWindow=function(a){$(c).bind("dialogclose",
function(){null!=a&&a($("#loginView_login").val())}).dialog("open")};return this};function EffectsController(d){d.globalCompositeOperation="lighter";var a=[];this.registerParticleSystem=function(c){a.push(c)};this.updateAndRender=function(c){for(var b=0;b<a.length;b++){a[b].update(c);a[b].render(d)}}};function Missile(a){this.name="Missile";this.damage=30;this.splash=0;this.quantity=typeof a=="undefined"?999:a;this.onHitPlayer=function(){};this.onHitStatic=function(){}};function Mortar(){this.name="Mortar";this.damage=40;this.splash=10;this.quantity=typeof quantity=="undefined"?10:quantity;this.onHitPlayer=function(){};this.onHitStatic=function(){}};